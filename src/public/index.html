<html>
  <head>
    <title>QuantumHub Processes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="css/default.css" />

    <script src="script/api.js"></script>
  </head>

  <body>
    <div class="container">
      <main class="l-main">
        <div class="p-panel">
          <div class="u-fixed-width" id="content">
            <h1>QuantumHub</h1>
            <div class="u-fixed-width">
              <div class="p-panel__header"></div>
              <div class="p-panel__content" id="content">
                <h4 class="p-muted-heading">RUNNING PROCESSES</h4>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </body>

  <script>
    processStatusSubscription((process) => {
      updateProcessStatus(process);
    });

    const onStartProcessClicked = (id) => {
      startProcess(id).then((response) => {
        console.log(response);
      });
    };

    const onStopProcessClicked = (id) => {
      stopProcess(id).then((response) => {
        console.log(response);
      });
    };

    const updateProcessStatus = (process) => {
      console.log(process);

      document.getElementById(`status_${process.identifier}`).innerText = process.status;
      const chip = document.getElementById(`status_${process.identifier}_chip`);
      chip.classList.remove('p-chip--positive');
      chip.classList.remove('p-chip--negative');

      if (process.status.toLowerCase() === 'running') {
        chip.classList.add('p-chip--positive');
      } else {
        chip.classList.add('p-chip--negative');
      }

      document.getElementById(`status_${process.identifier}_start`).disabled = process.status.toLowerCase() === 'running';
      document.getElementById(`status_${process.identifier}_stop`).disabled = !(process.status.toLowerCase() === 'running');
    };

    // Get the processes from the API
    getProcesses().then((processes) => {
      console.log(processes);
      // Create a table with the processes
      const table = document.createElement('table');
      table.innerHTML = `
          <thead>
            <tr>
              <th>Process Name</th>
              <th>Process Status</th>
              <th>Process Start time</th>
              <th/>
            </tr>
            </thead>
          `;

      processes.data.forEach((process) => {
        const row = document.createElement('tr');

        var startEnabled = process.status.toLowerCase() !== 'running' ? '' : 'disabled=""';
        var stopEnabled = process.status.toLowerCase() === 'running' ? '' : 'disabled=""';

        var statusColor = process.status.toLowerCase() === 'running' ? 'positive' : 'negative';

        const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        const time = new Date(process.startTime).toLocaleTimeString('en', { timeStyle: 'short', hour12: false, timeZone: timeZone });
        const date = new Date(process.startTime).toLocaleDateString('en', { dateStyle: 'short', hour12: false, timeZone: timeZone });

        row.innerHTML = `
              <td><a href="/process/details?identifier=${process.identifier}">${process.name}</a></td>
              <td>
                <span class="uk-badge">${process.status}</span>
                <button class="p-chip--${statusColor} is-dense is-small" id="status_${process.identifier}_chip">
                  <span class="p-chip__value" id="status_${process.identifier}">${process.status}</span>
                </button>
              </td>
              <td>${date} ${time}</td>
              <td>
                <button id="status_${process.identifier}_start" ${startEnabled} class="p-button--positive is-dense is-small" onclick="onStartProcessClicked('${process.identifier}')">Start</button>
                <button id="status_${process.identifier}_stop" ${stopEnabled} class="p-button--negative is-dense is-small" type="" class="bg-sky-500" onclick="onStopProcessClicked('${process.identifier}')">Stop</button>
              </td>
            `;
        table.appendChild(row);
      });

      const contentNode = document.getElementById('content');
      console.log(table);
      console.log(contentNode);
      contentNode.appendChild(table);
    });
  </script>
</html>
